<?xml version="1.0" encoding="UTF-8"?>
<!-- 회원관련 sql문 작성 -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.board.icia.dao.IBoardDao">

	<update id="updateBoardThumb">
		update BOARD set B_THUMBS = ( SELECT COUNT(*) FROM THUMB WHERE THUMB.T_NUM = BOARD.B_NUM )
	</update>

	<select id="getBoardList" resultType="Board">
	<!-- CDATA 를 써줘야 <  > 를 태그로 인식 안함 -->
		<![CDATA[
			SELECT * FROM (
				SELECT /*+INDEX_DESC(B PK_B_NUM)*/ ROWNUM RN, B.*
				FROM B
				WHERE ROWNUM<=#{pageNum}*10)
			WHERE RN>=#{pageNum}*10-9	
		]]>
		
	</select>

	<select id="getTop3List" resultType="Board">
		<![CDATA[
		
		SELECT * FROM (
				SELECT ROWNUM RN, B.*
				FROM B
				ORDER BY B_THUMBS DESC	)
			WHERE ROWNUM<=1*3
		]]>
	</select>
	
	<update id="viewCntUp">
		update BOARD set B_VIEWS = B_VIEWS + 1 where B_NUM = #{B_NUM}
	</update>

	<select id="getContents" resultType="Board">
		SELECT * FROM B WHERE B_NUM
		= #{bNum}
	</select>

	<select id="getReplyList" resultType="Reply">
		SELECT * FROM REPLY WHERE
		R_BNUM = #{r_bNum}
	</select>

	<insert id="replyInsert">
		INSERT INTO R
		VALUES(REPLY_SEQ.NEXTVAL,#{r_bnum},#{r_contents},#{r_id},default)
	</insert>

	<!--useGeneratedKeys="true" 자동증가값을 얻을 수 있다. keyProperty="b_num"(필드명) my-sql은 
		명시해야함. -->
	<insert id="boardWriteSelectKey" useGeneratedKeys="true" keyProperty="b_num">
		<selectKey keyProperty="b_num" resultType="int" order="BEFORE">
			SELECT BOARD_SEQ.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO B
		VALUES(#{b_num},#{b_title},#{b_contents},#{b_id},default,default)
	</insert>

	<insert id="fileInsert">
		INSERT INTO BF
		VALUES(BF_SEQ.NEXTVAL,#{bNum},#{oriFileName},#{sysFileName})
	</insert>

	<select id="getBfList" resultType="BoardFile">
		SELECT * FROM BF WHERE BF_BNUM
		= #{bNum}
	</select>


	<select id="myBatisTest" resultType="Member">
		SELECT * FROM MINFO WHERE
		<!-- mybatis 동적sql test가 조건문이다. -->
		<if test="point!=null">
			${colName} = #{point} AND
		</if>
		ROWNUM=1
	</select>


	<!-- resultType이 Map일땐 컬럼명이 속성으로 들어가게 됨. -->
	<!-- 그래서 jsp에 찍을땐 var 뒤에 대문자로 적어야 한다. -->
	<select id="myBatisTestMap" resultType="Map">
		SELECT * FROM MINFO WHERE
		<if test="search!=''">
			${colName} = #{search} AND
		</if>
		ROWNUM=1
	</select>
	
	<select id="checkThumbs" resultType="String">
		SELECT T_ID FROM THUMB WHERE T_ID = #{t_id} AND T_NUM = #{t_num}
	</select>

	<insert id="addThumbs">
		INSERT INTO THUMB(T_ID, T_NUM) VALUES(#{t_id},#{t_num})
	</insert>

	<select id="countThumbs" resultType="int">
		SELECT b_thumbs FROM BOARD WHERE B_NUM = #{t_num}
	</select>

</mapper> 
